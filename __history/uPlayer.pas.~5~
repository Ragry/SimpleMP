unit uPlayer;

interface

uses
  System.Classes, System.SysUtils;

type
  TPlayer = class
  private
    FChannel: Cardinal;
    FPlaying: Boolean;
    FByteLength: Int64;
    FTime: Cardinal;
    FOnStartPlaying: TNotifyEvent;
  public
    constructor Create(WinHandle: THandle);
    destructor Destroy; override;
    procedure Play;
    property Playing: Boolean read FPlaying;
    property Length: Int64 read FByteLength;
    property Time: Cardinal read FTime;
    property OnStartPlaying: TNotifyEvent read FOnStartPlaying write FOnStartPlaying;
  end;

implementation

uses
  bass;

{ TPlayer }

constructor TPlayer.Create(WinHandle: THandle);
begin
  FPlaying := False;
  if not BASS_Init(-1, 44100, 0, WinHandle, nil) then
		raise Exception.Create('Error initializing BASS!');
end;

destructor TPlayer.Destroy;
begin
  if FChannel > 0 then BASS_ChannelFree(FChannel);
	BASS_Free();
  inherited;
end;

procedure TPlayer.Play;
begin
  FPlaying := True;

  FChannel := BASS_StreamCreateFile(FALSE, FileName, 0, 0, BASS_UNICODE);

  FByteLength := BASS_ChannelGetLength(FChannel, BASS_POS_BYTE);
  FTime := Trunc(BASS_ChannelBytes2Seconds(FChannel, gageFilePosition.MaxValue));
  if Assigned(FOnGetLength) then FOnGetLength(Length);
  lblTimeMax.Caption := Format(' %d:%.2d', [Time div 60, Time mod 60]);

  BASS_ChannelSetPosition(FChannel, gageFilePosition.Progress, BASS_POS_BYTE);
  BASS_ChannelSetAttribute(FChannel, BASS_ATTRIB_VOL, gageVolume.Progress / 100);

  BASS_ChannelPlay(FChannel, False);
end;

end.
